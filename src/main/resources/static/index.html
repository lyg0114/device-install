<!DOCTYPE html>
<html>
<head>
  <title>Excel Upload Progress</title>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
<h1>Upload Progress</h1>
<div id="complete"></div>
<div id="progress">0%</div>

<form class="form-inline">
  <div class="form-group">
    <input type="file" id="file-input" name="file" accept=".xlsx, .xls" required>
    <button id="send" class="btn btn-default" type="submit">send</button>
    </button>
  </div>
</form>

<script>
  $(document).ready(function () {
    var socket = new WebSocket("ws://localhost:8080/progress");
    socket.onmessage = function (event) {
      var current = parseInt(event.data, 10);  // 문자열을 정수로 변환
      $('#progress').text("progress : " + current + "%");
      if (current >= 100) {
        $('#complete').text('Upload successful!');
      }
    };

    socket.onopen = function () {
      console.log("WebSocket connection opened.");
    };

    socket.onclose = function () {
      console.log("WebSocket connection closed.");
    };

    socket.onerror = function (error) {
      console.log("WebSocket error: " + error);
    };

    $('#send').on('click', function (event) {
      event.preventDefault();
      var fileInput = $('#file-input')[0];
      if (fileInput.files.length === 0) {
        alert("Please select a file!");
        return;
      }

      var formData = new FormData();
      formData.append('file', fileInput.files[0]);

      $.ajax({
        url: 'http://localhost:8080/api/modems/v1/excel',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        xhr: function () {
          var xhr = new window.XMLHttpRequest();
          xhr.upload.addEventListener('progress', function (event) {
            if (event.lengthComputable) {
              var percentComplete = Math.round((event.loaded / event.total) * 100);
              $('#progress').text(percentComplete + '%');
              $('#progress-bar-fill').css('width', percentComplete + '%').text(
                  percentComplete + '%');
            }
          }, false);
          return xhr;
        },
        success: function () {
          console.log("call - /excel success");
        },
        error: function () {
          $('#progress').text('Upload failed!');
        }
      });
    });
  });</script>
</body>
</html>
